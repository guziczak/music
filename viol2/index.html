<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skrzypce: Climax Motif - Nauka (I Pozycja)</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #00bcd4;
            --string-g: #9e9e9e; /* Silver */
            --string-d: #d4af37; /* Gold */
            --string-a: #2196f3; /* Blue - common synthetic */
            --string-e: #4caf50; /* Green - often distinct */
            --finger-active: #ff4081;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
        }

        h1 {
            margin-bottom: 10px;
            font-weight: 300;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background-color: var(--accent-color);
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #00acc1;
        }
        
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Violin Neck Container */
        .violin-neck {
            position: relative;
            width: 300px;
            height: 500px;
            background: #2c2c2c; /* Ebony fingerboard */
            border-radius: 10px 10px 0 0;
            border: 2px solid #444;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        /* Nut */
        .nut {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 15px;
            background: #dcdcdc; /* Bone/Ivory */
            border-bottom: 2px solid #111;
            z-index: 10;
        }

        /* Strings */
        .string {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            margin-left: -2px;
            z-index: 5;
            box-shadow: 1px 0 2px rgba(0,0,0,0.5);
        }

        /* Tapes/Frets markers (visual aid only for beginner) */
        .tape {
            position: absolute;
            left: 0;
            width: 100%;
            height: 1px;
            background: rgba(255,255,255,0.1);
            pointer-events: none;
        }
        .tape-label {
            position: absolute;
            right: -30px;
            font-size: 10px;
            color: #666;
            transform: translateY(-50%);
        }

        /* String Positions */
        .str-g { left: 20%; background: linear-gradient(90deg, #777, var(--string-g), #777); }
        .str-d { left: 40%; background: linear-gradient(90deg, #997e28, var(--string-d), #997e28); }
        .str-a { left: 60%; background: linear-gradient(90deg, #1565c0, var(--string-a), #1565c0); }
        .str-e { left: 80%; background: linear-gradient(90deg, #2e7d32, var(--string-e), #2e7d32); }

        /* String Labels */
        .string-label {
            position: absolute;
            bottom: -30px;
            transform: translateX(-50%);
            font-weight: bold;
        }

        /* Finger Dot */
        .finger-dot {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--finger-active);
            border: 2px solid #fff;
            box-shadow: 0 0 10px var(--finger-active);
            transform: translate(-50%, -50%);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.1s;
        }

        /* Note Info Display */
        .note-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 80px;
        }
        
        #noteDisplay {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .sub-info {
            font-size: 16px;
            color: #aaa;
        }

        .highlight-e {
            color: var(--string-e);
            font-weight: bold;
            text-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }

        /* Progress Bar */
        .progress-bar {
            width: 300px;
            height: 4px;
            background: #333;
            margin-top: 10px;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.1s linear;
        }

        /* MIRACLE GAP OVERLAY */
        .miracle-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.0);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* NAPIS NA GÓRZE */
            padding-top: 80px;      /* Odstęp od krawędzi */
            font-size: 80px;
            font-weight: bold;
            color: #ffd700;
            text-transform: uppercase;
            text-shadow: 0 0 20px #ff4081, 0 0 50px #ffd700;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            font-family: 'Impact', sans-serif;
            letter-spacing: 5px;
            transform: scale(1.2);
        }

    </style>
</head>
<body>

    <div id="miracleOverlay" class="miracle-overlay">MIRACLE GAP</div>

    <h1>Skrzypce: Climax Motif</h1>
    
    <div class="controls">
        <button id="btnPlay" onclick="startPlayback()">Graj</button>
        <button id="btnStop" onclick="stopPlayback()" disabled>Stop</button>
        <div class="slider-container">
            <label for="tempo">Tempo:</label>
            <input type="range" id="tempo" min="50" max="150" value="103">
            <span id="tempoDisplay">103 BPM</span>
        </div>
    </div>

    <div class="note-info">
        <div id="noteDisplay">Gotowy?</div>
        <div class="sub-info" id="fingerDisplay">I Pozycja</div>
    </div>

    <div class="violin-neck">
        <!-- Nut -->
        <div class="nut"></div>

        <!-- Strings -->
        <div class="string str-g"><div class="string-label" style="bottom:-25px; left:50%">G</div></div>
        <div class="string str-d"><div class="string-label" style="bottom:-25px; left:50%">D</div></div>
        <div class="string str-a"><div class="string-label" style="bottom:-25px; left:50%">A</div></div>
        <div class="string str-e"><div class="string-label" style="bottom:-25px; left:50%">E</div></div>

        <!-- Visual Tapes (approximate positions for 1st pos) -->
        <div class="tape" style="top: 55px;"><span class="tape-label">1 (Low)</span></div> 
        <div class="tape" style="top: 80px;"><span class="tape-label">1</span></div>      
        <div class="tape" style="top: 130px;"><span class="tape-label">2 (Low)</span></div> 
        <div class="tape" style="top: 155px;"><span class="tape-label">2</span></div>       
        <div class="tape" style="top: 200px;"><span class="tape-label">3</span></div>       
        <div class="tape" style="top: 270px;"><span class="tape-label">4</span></div>       

        <!-- Active Dot -->
        <div id="activeDot" class="finger-dot"></div>
    </div>

    <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
    </div>

    <script>
        // --- DANE MUZYCZNE ---
        
        // Część 1: Oryginalny Motyw (0 - 16 beat)
        const PART_1 = [
            ['A3', 0, 4, 0.65], ['D4', 0, 4, 0.7], ['A4', 0, 1.5, 1.0], 
            ['G4', 1.5, 0.5, 0.92], ['F4', 2, 1, 0.98], ['E4', 3, 0.5, 0.90], ['D4', 3.5, 0.5, 0.88],
            ['C4', 4, 0.75, 0.90], ['D4', 4.75, 0.25, 0.86], ['E4', 5, 1.5, 0.98],
            ['F4', 6.5, 1, 0.95], ['G4', 7.5, 0.5, 0.92],
            ['A4', 8, 0.75, 1.0], ['Bb4', 8.75, 0.25, 0.96], ['C5', 9, 1, 1.0],
            ['D5', 10, 1, 1.0], ['C5', 11, 0.5, 0.98], ['Bb4', 11.5, 0.5, 0.92],
            ['A4', 12, 1.5, 1.0], ['G4', 13.5, 0.5, 0.92],
            ['F4', 14, 0.5, 0.96], ['E4', 14.5, 0.5, 0.90], ['D4', 15, 1, 0.98]
        ];

        // Część 2: DOKŁADNE POWTÓRZENIE MOTYWU (z Ozdobnikiem na start) (16 - 32 beat)
        const PART_2 = JSON.parse(JSON.stringify(PART_1)).map(n => {
            n[1] += 16; 
            return n;
        });

        // Ozdobnik na start
        const p2_start_idx = PART_2.findIndex(n => n[1] === 16 && n[0] === 'A4');
        if (p2_start_idx !== -1) {
            PART_2.splice(p2_start_idx, 1, 
                ['A4', 16, 0.25, 1.0], 
                ['Bb4', 16.25, 0.25, 0.96], 
                ['A4', 16.5, 1.0, 1.0]
            );
        }

        // Część 3: WIELKA WARIACJA "SKOKOWA" (Heroiczna i Wirtuozerska) (32+ beat)
        const PART_3 = [
            // --- SEKCJA A: AKROBATYKA (Pytanie - Odpowiedź) ---
            ['D4', 32, 0.5, 1.0], ['F5', 32.5, 0.5, 0.9], 
            ['A3', 33, 0.5, 1.0], ['E5', 33.5, 0.5, 0.9], 
            ['D4', 34, 0.5, 1.0], ['D5', 34.5, 0.5, 0.9], 
            ['A4', 35, 0.5, 1.0], ['A5', 35.5, 0.5, 0.95], 

            // Kaskada w dół
            ['G5', 36, 0.25, 0.9], ['F5', 36.25, 0.25, 0.9], ['E5', 36.5, 0.25, 0.9], ['D5', 36.75, 0.25, 0.9],
            ['C5', 37, 0.25, 0.9], ['Bb4', 37.25, 0.25, 0.9], ['A4', 37.5, 1.0, 1.0], 

            // --- SEKCJA B: TEMAT HEROICZNY (Wyraźna melodia) ---
            ['D5', 39, 1.5, 1.0], ['E5', 40.5, 0.5, 1.0], 
            ['F5', 41, 1.0, 1.0], ['G5', 42, 0.5, 1.0], ['A5', 42.5, 0.5, 1.0],
            
            // Dramatyczne zawieszenie
            ['Bb4', 43, 1.0, 0.95], ['A5', 44, 1.5, 1.0], 
            ['G5', 45.5, 0.5, 0.95], 
            
            // --- SEKCJA C: BARIOLAGE (Migotanie / Wirtuozeria) ---
            ['F5', 46, 0.25, 1.0], ['A4', 46.25, 0.25, 0.8], ['E5', 46.5, 0.25, 1.0], ['A4', 46.75, 0.25, 0.8],
            ['D5', 47, 0.25, 1.0], ['A4', 47.25, 0.25, 0.8], ['C5', 47.5, 0.25, 1.0], ['A4', 47.75, 0.25, 0.8],
            
            ['Bb4', 48, 0.25, 1.0], ['A4', 48.25, 0.25, 0.8], ['G4', 48.5, 0.25, 1.0], ['A4', 48.75, 0.25, 0.8],
            ['F4', 49, 0.5, 1.0], ['E4', 49.5, 0.5, 1.0], 
            
            // --- SEKCJA D: WIELKI FINAŁ ---
            ['D4', 50, 1.0, 1.0], ['F4', 51, 1.0, 1.0], ['A4', 52, 1.0, 1.0], ['D5', 53, 1.0, 1.0],
            ['E5', 54, 1.0, 1.0], ['F5', 55, 2.0, 1.0], 
            
            ['E5', 57, 1.0, 0.95], ['D5', 58, 1.0, 0.95], 
            ['C5', 59, 1.0, 0.9], ['Bb4', 60, 1.0, 0.9], 

            // --- "SKOCZKA" (CRAZY POSITIVE JUMPER) --- 
            ['A4', 61, 0.25, 1.0], ['D5', 61.25, 0.25, 1.0], ['F5', 61.5, 0.25, 1.0], ['A5', 61.75, 0.25, 1.0],
            ['E5', 62, 0.25, 1.0], ['A4', 62.25, 0.25, 1.0], 
            ['F5', 62.5, 0.25, 1.0], ['A4', 62.75, 0.25, 1.0], 
            ['D6', 63, 0.25, 1.0], ['A5', 63.25, 0.25, 1.0], 
            ['F5', 63.5, 0.25, 1.0], ['E5', 63.75, 0.25, 1.0], 

            // --- THE MIRACLE GAP (EXTENDED EDITION) ---
            // 1. MACHINE GUN
            ['C6', 64, 0.15, 1.0], ['A5', 64.15, 0.15, 1.0], ['E5', 64.30, 0.15, 1.0], ['A5', 64.45, 0.15, 1.0],
            ['C6', 64.60, 0.15, 1.0], ['E6', 64.75, 0.25, 1.0], 

            // 2. LASER SWEEP
            ['G3', 65, 0.15, 1.0], ['D4', 65.15, 0.15, 1.0], ['A4', 65.30, 0.15, 1.0], ['E5', 65.45, 0.15, 1.0],
            ['A5', 65.60, 0.15, 1.0], ['C6', 65.75, 0.15, 1.0], ['E6', 65.90, 0.15, 1.0], 
            
            // 3. GALACTIC SPIRAL (NOWOŚĆ)
            ['C6', 66, 0.25, 1.0], ['A5', 66.25, 0.25, 1.0], ['E5', 66.5, 0.25, 1.0], ['C5', 66.75, 0.25, 1.0],
            ['E5', 67, 0.25, 1.0], ['A5', 67.25, 0.25, 1.0], ['C6', 67.5, 0.25, 1.0], ['E6', 67.75, 0.5, 1.0],

            ['D6', 68.25, 0.25, 1.0], ['A5', 68.5, 0.25, 1.0], ['F5', 68.75, 0.25, 1.0], ['D5', 69, 0.25, 1.0],
            ['F5', 69.25, 0.25, 1.0], ['A5', 69.5, 0.25, 1.0], ['D6', 69.75, 0.5, 1.0],

            // 4. METEOR SHOWER (NOWOŚĆ)
            ['F6', 70.25, 0.15, 1.0], ['E6', 70.40, 0.15, 1.0], ['D6', 70.55, 0.15, 1.0], ['C6', 70.70, 0.15, 1.0],
            ['Bb5', 70.85, 0.15, 1.0], ['A5', 71.00, 0.15, 1.0], ['G5', 71.15, 0.15, 1.0], ['F5', 71.30, 0.15, 1.0],
            
            // 5. BOSKI TRYL
            ['F6', 72, 0.25, 1.0], ['E6', 72.25, 0.25, 1.0], ['F6', 72.5, 0.25, 1.0], ['E6', 72.75, 0.25, 1.0],
            ['F6', 73, 0.25, 1.0], ['E6', 73.25, 0.25, 1.0], ['F6', 73.5, 0.25, 1.0], ['E6', 73.75, 1.25, 1.0],

            // Ostateczny Akord
            ['D4', 80, 10.0, 0.85], ['A3', 80, 10.0, 0.85], ['F4', 80, 10.0, 0.75], ['D5', 80, 10.0, 0.6]
        ];

        const FULL_SCORE = [...PART_1, ...PART_2, ...PART_3];

        // Uproszczenie dla wizualizacji
        const MELODY_ONLY = FULL_SCORE.filter(n => {
            if ((n[1] === 0 || n[1] === 16) && (n[0] === 'A3' || n[0] === 'D4')) return false; 
            // Pokaż tylko najwyższą nutę (D5) w finałowym akordzie (beat 80)
            if (n[1] >= 80 && n[0] !== 'D5') return false; 
            return true;
        });

        const FREQ = {
            'A3': 220, 'C4': 262, 'D4': 294, 'E4': 330, 'F4': 349, 'G4': 392, 'A4': 440, 'B4': 494, 
            'Bb4': 466, 'C5': 523, 'C#5': 554, 'D5': 587, 'D#5': 622, 'E5': 659, 
            'F5': 698, 'F#5': 740, 'G5': 784, 'G#5': 830, 'A5': 880, 'Bb5': 932,
            'B5': 987, 'C6': 1046, 'D6': 1174, 'E6': 1318, 'F6': 1396
        };

        const FINGER_MAP = {
            'G3': [0, 0, 'Pusta (0)', 0],
            'A3': [0, 80, '1 palec', 1],
            'B3': [0, 155, '2 palec', 2],
            'C4': [0, 200, '3 palec', 3],
            
            'D4': [1, 0, 'Pusta (0)', 0],
            'E4': [1, 80, '1 palec', 1],
            'F4': [1, 130, '2 palec (niski)', 2], 
            'G4': [1, 200, '3 palec', 3],
            
            'A4': [2, 0, 'Pusta (0)', 0],
            'Bb4': [2, 55, '1 palec (niski)', 1],
            'B4': [2, 80, '1 palec', 1],
            'C5': [2, 130, '2 palec (niski)', 2], 
            'C#5': [2, 140, '2+ (wysoki)', 2],
            'D5': [2, 200, '3 palec', 3],
            'D#5': [2, 210, '4 palec', 4],
            
            'E5': [3, 0, 'Pusta (0)', 0],
            'F5': [3, 55, '1 palec (niski)', 1],  
            'F#5': [3, 65, '1+ (wysoki)', 1],
            'G5': [3, 130, '2 palec (niski)', 2], 
            'G#5': [3, 140, '2+ (wysoki)', 2],
            'A5': [3, 200, '3 palec', 3],
            'Bb5': [3, 240, '4 palec (ext)', 4],
            'C6': [3, 270, 'Pozycja V', 1],
            'D6': [3, 300, 'Pozycja V', 2],
            'E6': [3, 330, 'Pozycja VII', 3],
            'F6': [3, 350, 'Pozycja VII', 4] 
        };
        
        const STRING_POS_PCT = [20, 40, 60, 80];

        let audioCtx = null;
        let masterGain = null;
        let reverbNode = null;
        let isPlaying = false;
        let timeouts = [];
        let tempo = 103;

        const tempoInput = document.getElementById('tempo');
        const tempoDisplay = document.getElementById('tempoDisplay');
        
        tempoInput.addEventListener('input', (e) => {
            tempo = parseInt(e.target.value);
            tempoDisplay.textContent = `${tempo} BPM`;
        });

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.6;
                reverbNode = audioCtx.createConvolver();
                reverbNode.buffer = createReverbImpulse(3.0);
                const dryGain = audioCtx.createGain();
                dryGain.gain.value = 0.7;
                const wetGain = audioCtx.createGain();
                wetGain.gain.value = 0.6;
                masterGain.connect(dryGain);
                masterGain.connect(reverbNode);
                dryGain.connect(audioCtx.destination);
                reverbNode.connect(wetGain);
                wetGain.connect(audioCtx.destination);
            }
        }

        function createReverbImpulse(duration) {
            const length = audioCtx.sampleRate * duration;
            const impulse = audioCtx.createBuffer(2, length, audioCtx.sampleRate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);
            for (let i = 0; i < length; i++) {
                const n = i / length;
                const noise = (Math.random() * 2 - 1) * Math.pow(1 - n, 2); 
                left[i] = noise;
                right[i] = noise;
            }
            return impulse;
        }

        function playTone(freq, duration, velocity) {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            const t = now;
            const stopTime = t + duration;
            const osc1 = audioCtx.createOscillator();
            osc1.type = 'sawtooth';
            osc1.frequency.value = freq;
            const osc2 = audioCtx.createOscillator();
            osc2.type = 'sawtooth';
            osc2.frequency.value = freq;
            osc2.detune.value = 4;
            const osc3 = audioCtx.createOscillator();
            osc3.type = 'triangle';
            osc3.frequency.value = freq;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.Q.value = 1;
            const baseFreq = freq * 2; 
            const peakFreq = freq * (4 + (velocity * 4));
            filter.frequency.setValueAtTime(baseFreq, t);
            filter.frequency.linearRampToValueAtTime(peakFreq, t + 0.1);
            filter.frequency.exponentialRampToValueAtTime(baseFreq, stopTime);
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0, t);
            gainNode.gain.linearRampToValueAtTime(velocity, t + 0.08);
            gainNode.gain.setValueAtTime(velocity, stopTime - 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.001, stopTime + 0.5);
            const lfo = audioCtx.createOscillator();
            lfo.frequency.value = 5.5;
            const lfoGain = audioCtx.createGain();
            lfoGain.gain.setValueAtTime(0, t);
            lfoGain.gain.linearRampToValueAtTime(freq * 0.015, t + 0.5);
            lfo.connect(lfoGain);
            lfoGain.connect(osc1.frequency);
            lfoGain.connect(osc2.frequency);
            osc1.connect(filter);
            osc2.connect(filter);
            osc3.connect(filter); 
            filter.connect(gainNode);
            gainNode.connect(masterGain);
            osc1.start(t);
            osc2.start(t);
            osc3.start(t);
            lfo.start(t);
            osc1.stop(stopTime + 1.0);
            osc2.stop(stopTime + 1.0);
            osc3.stop(stopTime + 1.0);
            lfo.stop(stopTime + 1.0);
            setTimeout(() => {
                gainNode.disconnect();
            }, (duration + 1.5) * 1000);
        }

        function showNoteVisual(noteName) {
            const map = FINGER_MAP[noteName];
            console.log('Visual:', noteName, map); // DEBUG

            const dot = document.getElementById('activeDot');
            const info = document.getElementById('noteDisplay');
            const sub = document.getElementById('fingerDisplay');
            
            if (!info || !sub || !dot) return;

            // Reset string visual
            const strings = document.querySelectorAll('.string');
            strings.forEach(s => s.style.boxShadow = '1px 0 2px rgba(0,0,0,0.5)');

            if (!map) {
                dot.style.opacity = 0;
                return;
            }

            const [strIdx, topPx, fingerLabel, fingerNum] = map;
            console.log('Setting pos:', STRING_POS_PCT[strIdx], topPx); // DEBUG

            // Position Dot
            dot.style.left = STRING_POS_PCT[strIdx] + '%';
            dot.style.top = topPx + 'px';
            dot.style.opacity = 1;

            // Highlight String
            const strColor = ['var(--string-g)', 'var(--string-d)', 'var(--string-a)', 'var(--string-e)'][strIdx];
            strings[strIdx].style.boxShadow = `0 0 15px ${strColor}`;

            // Text Info
            if (strIdx === 3) {
                info.innerHTML = `<span class="highlight-e">${noteName}</span>`;
                sub.innerHTML = `Struna: <b>E</b> | ${fingerLabel} <span style="color:var(--string-e)">(⚠️ Struna E)</span>`;
            } else {
                info.textContent = noteName;
                sub.innerHTML = `Struna: <b>${['G', 'D', 'A', 'E'][strIdx]}</b> | ${fingerLabel}`;
            }
        }

        function clearVisual() {
            const dot = document.getElementById('activeDot');
            if(dot) dot.style.opacity = 0;
            document.querySelectorAll('.string').forEach(s => s.style.boxShadow = '1px 0 2px rgba(0,0,0,0.5)');
        }

        function startPlayback() {
            if (isPlaying) return;
            initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            isPlaying = true;
            document.getElementById('btnPlay').disabled = true;
            document.getElementById('btnStop').disabled = false;
            document.getElementById('tempo').disabled = true;

            const secPerBeat = 60 / tempo;
            
            let maxBeat = 0;
            MELODY_ONLY.forEach(n => {
                const end = n[1] + n[2];
                if (end > maxBeat) maxBeat = end;
            });
            const totalDuration = (maxBeat + 2) * secPerBeat * 1000;

            const pBar = document.getElementById('progressFill');
            pBar.style.transition = `width ${totalDuration}ms linear`;
            pBar.style.width = '100%';

            MELODY_ONLY.forEach(item => {
                const [note, startBeat, durBeats, vel] = item;
                const startTimeMs = startBeat * secPerBeat * 1000;
                const durationSec = durBeats * secPerBeat;

                const audioTimer = setTimeout(() => {
                    playTone(FREQ[note], durationSec, vel);
                }, startTimeMs);
                timeouts.push(audioTimer);

                const visTimer = setTimeout(() => {
                    showNoteVisual(note);
                }, startTimeMs);
                timeouts.push(visTimer);
                
                // MIRACLE GAP TRIGGER
                if (Math.abs(startBeat - 64) < 0.1) {
                     const overlayTimer = setTimeout(() => {
                        const ov = document.getElementById('miracleOverlay');
                        if(ov) {
                            ov.style.opacity = 1;
                            ov.style.transform = "scale(1.5)";
                            setTimeout(() => ov.style.transform = "scale(1.2)", 200);
                        }
                        setTimeout(() => { 
                            if(ov) ov.style.opacity = 0; 
                        }, 10000); // 10 sekund
                    }, startTimeMs);
                    timeouts.push(overlayTimer);
                }
            });

            const endTimer = setTimeout(() => {
                stopPlayback();
            }, totalDuration + 500);
            timeouts.push(endTimer);
        }

        function stopPlayback() {
            isPlaying = false;
            timeouts.forEach(t => clearTimeout(t));
            timeouts = [];
            
            const btnPlay = document.getElementById('btnPlay');
            const btnStop = document.getElementById('btnStop');
            const tempoIn = document.getElementById('tempo');
            const pBar = document.getElementById('progressFill');
            const overlay = document.getElementById('miracleOverlay');
            
            if(btnPlay) btnPlay.disabled = false;
            if(btnStop) btnStop.disabled = true;
            if(tempoIn) tempoIn.disabled = false;
            if(pBar) {
                pBar.style.transition = 'none';
                pBar.style.width = '0%';
            }
            if(overlay) overlay.style.opacity = 0;
            
            clearVisual();
            
            const nDisp = document.getElementById('noteDisplay');
            const fDisp = document.getElementById('fingerDisplay');
            if(nDisp) nDisp.textContent = "Koniec";
            if(fDisp) fDisp.textContent = "I Pozycja";
        }

        console.log("Gotowe, teraz to jest już pierdolona epopeja");
    </script>
</body>
</html>